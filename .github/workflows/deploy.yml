name: Deploy to ECS (Fargate) with Unique Docker Tag

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
      IMAGE_REPO_NAME: ${{ secrets.ECR_REPOSITORY }}
      IMAGE_TAG: myjavaapp-${{ github.run_number }}-${{ github.sha }}

    steps:
    # Step 1: Checkout code
    - name: Checkout code
      uses: actions/checkout@v2

    # Step 2: Set up Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    # Step 3: Build Docker image with a unique tag
    - name: Build Docker image
      run: |
        docker build -t $IMAGE_REPO_NAME:$IMAGE_TAG .

    # Step 4: Log in to Amazon ECR
    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v1
      with:
        region: ${{ secrets.AWS_REGION }}

    # Step 5: Tag image for ECR
    - name: Tag image
      run: |
        docker tag $IMAGE_REPO_NAME:$IMAGE_TAG $ECR_REGISTRY/$IMAGE_REPO_NAME:$IMAGE_TAG

    # Step 6: Push image to ECR
    - name: Push image to ECR
      run: |
        docker push $ECR_REGISTRY/$IMAGE_REPO_NAME:$IMAGE_TAG

    # Step 7: Get current task definition
    - name: Download existing task definition
      run: |
        aws ecs describe-task-definition \
          --task-definition ${{ secrets.TASK_DEFINITION_NAME }} \
          --region $AWS_REGION \
          --query "taskDefinition" > task-definition.json

    # Step 8: Replace image in task definition
    - name: Update image in task definition
      run: |
        jq --arg IMAGE "$ECR_REGISTRY/$IMAGE_REPO_NAME:$IMAGE_TAG" \
        '.containerDefinitions[0].image = $IMAGE | 
         {family: .family, executionRoleArn, taskRoleArn, networkMode, containerDefinitions, requiresCompatibilities, cpu, memory}' \
        task-definition.json > new-task-def.json

    # Step 9: Register new task definition revision
    - name: Register new task definition
      run: |
        aws ecs register-task-definition \
          --region $AWS_REGION \
          --cli-input-json file://new-task-def.json

    # Step 10: Update ECS service with new task definition
    - name: Deploy updated task definition to ECS
      run: |
        NEW_REVISION=$(aws ecs describe-task-definition \
          --task-definition ${{ secrets.TASK_DEFINITION_NAME }} \
          --region $AWS_REGION \
          --query "taskDefinition.revision" --output text)

        aws ecs update-service \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --service ${{ secrets.ECS_SERVICE }} \
          --task-definition ${{ secrets.TASK_DEFINITION_NAME }}:$NEW_REVISION \
          --region $AWS_REGION
